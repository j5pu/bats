#!/bin/sh

#
# quick release script base on name of the script

set -eu

cd "$(git rev-parse --show-toplevel)"

action="${0##*/}"

all() {
  git add -A
  diff="$(git diff --name-status -r | awk '{print $2}' | tr '\n' ' ')"
  test -z "$(git status --porcelain)" || git commit --quiet -m "${0##*/}: $(date +%Y-%m-%d) ${diff}"
  git status | grep -q "is up to date" || git push --quiet
}

isauto() { [ "${action}" = "auto" ]; }

ispython() { [ -f setup.cfg ]; }

venv() {
  ispython || return 0
  test -f ./venv/bin/activate || python3 -m venv venv
  grep -q '.pyenv' ./venv/bin/activate || echo 'eval $$\(pyenv init --path)' >> ./venv/bin/activate
  . ./venv/bin/activate
}

make tests

git add -A
diff="$(git diff --name-status -r | awk '{print $2}' | tr '\n' ' ')"
test -z "$(git status --porcelain)" || git commit --quiet -m "${0##*/}: $(date +%Y-%m-%d) ${diff}"
git status | grep -q "is up to date" || git push --quiet

current="$(svu)"
next="$(svu next)"
[ "${current}" != "${next}" ] || exit 0

main "$@"
